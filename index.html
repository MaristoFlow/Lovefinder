<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Lovefinder â€” v3.2 Elite</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="description" content="Invitation-only Lovefinder. Precision A,S,E,C model with asymmetric age effects and human-grade guidance.">
  <style>
    /* ================= THEME (Elite) ================= */
    :root{
      /* Dark (Noir) */
      --bg-start:#0b0a11;
      --bg-end:#151322;
      --bg-rad1:#2b1b44;
      --bg-rad2:#0e0b18;

      --ink:#f6f4fb;        /* porcelain */
      --ink-soft:#d8d2ea;   /* soft porcelain */
      --muted:#a79fc6;      /* lavender slate */
      --line:rgba(255,255,255,.12);

      --accent:#ff7dab;     /* rose */
      --accent-2:#b78bfa;   /* lilac */
      --accent-3:#ffd27d;   /* champagne gold */

      --good:#7df7c6; --mid:#ffd27d; --warn:#ffb487; --low:#ff8a9e;

      --card-bg:rgba(255,255,255,.06);
      --card-blur:12px;

      --control-bg:rgba(255,255,255,.06);
      --control-hover:rgba(255,255,255,.12);
      --control-ring:rgba(183,139,250,.30);
      --chip-bg:rgba(255,255,255,.04);
      --chip-ink:#cbb9da;

      --cta-ink:#140c16;
      --cta-shadow:0 12px 30px rgba(255,125,171,.28);

      --ring-track:rgba(255,255,255,.12);
      --ring-gap:14px;
    }
    [data-theme="light"]{
      /* Light (Ivory) */
      --bg-start:#f8f6fd;
      --bg-end:#ffffff;
      --bg-rad1:#efe9ff;
      --bg-rad2:#ffffff;

      --ink:#1a1630;
      --ink-soft:#3d365f;
      --muted:#6e6791;
      --line:rgba(0,0,0,.10);

      --accent:#e8518f; --accent-2:#7b58e3; --accent-3:#f2b648;

      --good:#1d9a7b; --mid:#c58b1a; --warn:#c06a32; --low:#c23c59;

      --card-bg:rgba(255,255,255,.92);
      --card-blur:10px;

      --control-bg:#ffffff;
      --control-hover:#f1eefb;
      --control-ring:rgba(123,88,227,.28);
      --chip-bg:#f3f0fb;
      --chip-ink:#6e6791;

      --cta-ink:#ffffff;
      --cta-shadow:0 10px 26px rgba(123,88,227,.22);

      --ring-track:rgba(0,0,0,.08);
    }

    /* ================= FOUNDATION ================= */
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:var(--ink);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(1200px 600px at 15% -10%, var(--bg-rad1) 0%, transparent 60%),
        radial-gradient(1000px 800px at 110% 15%, var(--bg-rad2) 0%, transparent 55%),
        linear-gradient(180deg, var(--bg-start), var(--bg-end));
      position:relative; overflow-x:hidden;
    }

    /* Subtle grain for premium feel */
    .grain{pointer-events:none; position:fixed; inset:0; opacity:.05; mix-blend-mode:soft-light;
      background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="140" height="140" viewBox="0 0 140 140"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.8" numOctaves="4" stitchTiles="stitch"/></filter><rect width="100%" height="100%" filter="url(%23n)" opacity="0.6"/></svg>');
      background-size:240px 240px;
    }

    /* Sparkles for good outcomes */
    .sparkle{
      pointer-events:none; position:fixed; inset:0;
      background:
        radial-gradient(2px 2px at 10% 20%, rgba(255,255,255,.75), transparent 60%),
        radial-gradient(2px 2px at 30% 80%, rgba(255,255,255,.6), transparent 60%),
        radial-gradient(2px 2px at 70% 30%, rgba(255,218,185,.8), transparent 60%),
        radial-gradient(2px 2px at 85% 60%, rgba(255,192,203,.7), transparent 60%),
        radial-gradient(3px 3px at 50% 50%, rgba(255,255,255,.5), transparent 60%);
      mix-blend-mode:screen; opacity:0; transition:opacity .8s ease;
      animation:twinkle 7s linear infinite;
    }
    @keyframes twinkle{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}
    .celebrate .sparkle{ opacity:.5 }
    [data-theme="light"] .celebrate .sparkle{ opacity:.28 }

    /* Header with crest */
    header{padding:28px 16px 16px; text-align:center}
    .brand{
      display:flex; align-items:center; justify-content:center; gap:14px;
    }
    .crest{
      width:38px; height:38px; border-radius:12px; position:relative; flex:none;
      background:linear-gradient(135deg, rgba(255,255,255,.12), rgba(255,255,255,.02));
      border:1px solid var(--line);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.28), 0 10px 24px rgba(0,0,0,.22);
      display:grid; place-items:center;
    }
    .crest::after{
      content:"LF"; font-weight:900; font-size:.95rem;
      background:linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
      letter-spacing:.5px;
    }
    header h1{
      margin:0; font-size:1.9rem; letter-spacing:.25px; line-height:1.15;
      background:linear-gradient(90deg, var(--accent), var(--accent-2), var(--accent-3));
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    header p{margin:8px 0 0; color:var(--ink-soft)}

    main{max-width:980px;margin:0 auto;padding:16px;display:grid;gap:18px}

    /* Glass cards with couture edges */
    .card{
      background:var(--card-bg); border:1px solid var(--line); border-radius:20px; padding:18px;
      backdrop-filter:blur(var(--card-blur));
      box-shadow:
        0 18px 40px rgba(0,0,0,.22),
        inset 0 1px 0 rgba(255,255,255,.10);
      position:relative;
    }
    .card::before{
      content:""; position:absolute; inset:0; border-radius:20px; pointer-events:none;
      background:linear-gradient(120deg, rgba(255,255,255,.16), transparent 40%, transparent 60%, rgba(255,255,255,.06) 100%);
      mask:linear-gradient(#000,#000) content-box,linear-gradient(#000,#000);
      -webkit-mask:linear-gradient(#000,#000) content-box,linear-gradient(#000,#000);
      -webkit-mask-composite: xor; mask-composite: exclude;
      padding:1px;
    }
    .section-title{margin:.2rem 0 .8rem 0; font-weight:800; letter-spacing:.3px}

    .grid{display:grid;gap:12px}
    .two{grid-template-columns:1fr 1fr}
    @media (max-width:760px){.two{grid-template-columns:1fr}}

    label{font-size:.95rem;color:var(--muted);display:block;margin-bottom:6px}
    select,input[type="number"]{
      width:100%;padding:12px;border-radius:12px;border:1px solid var(--line);
      background:var(--control-bg); color:var(--ink); outline:none;
      transition:box-shadow .2s ease, border-color .2s ease, background .2s ease, transform .06s ease;
    }
    select:focus,input[type="number"]:focus{
      border-color:rgba(255,255,255,.28);
      box-shadow:0 0 0 3px var(--control-ring);
    }
    select:active,input[type="number"]:active{transform:translateY(1px)}

    .pill{
      display:inline-block;padding:6px 12px;border-radius:999px;border:1px solid var(--line);
      color:var(--chip-ink); font-size:.85rem; margin:6px 8px 10px 0; background:var(--chip-bg)
    }
    .small{font-size:.95rem;color:var(--muted)}

    /* Number pickers (jeweled state) */
    .num-card .legend{color:var(--muted);font-size:.9rem;margin:2px 0 10px}
    .num-grid{display:grid;grid-template-columns:repeat(10, minmax(36px,1fr));gap:7px}
    .num-grid button{
      border:1px solid var(--line); border-radius:12px; padding:9px 0; background:var(--control-bg);
      color:var(--ink); cursor:pointer; font-weight:700;
      transition:transform .06s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }
    .num-grid button:hover{background:var(--control-hover)}
    .num-grid button:active{transform:translateY(1px)}
    .num-grid button.active{
      background:linear-gradient(90deg,var(--accent),var(--accent-2),var(--accent-3));
      color:var(--cta-ink); border-color:transparent;
      box-shadow:0 6px 18px rgba(255,125,171,.30);
    }

    /* Score styles */
    .score{font-size:2.6rem;font-weight:900;letter-spacing:.5px;text-shadow:0 1px 0 rgba(0,0,0,.2)}
    .match-likely{color:var(--good)}
    .match-match{color:var(--mid)}
    .match-chal{color:var(--warn)}
    .match-unre{color:var(--low)}
    hr{border:0;border-top:1px solid var(--line);margin:16px 0}

    .blurb{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line); border-radius:14px; padding:12px; line-height:1.55;
      box-shadow:inset 0 1px 0 rgba(255,255,255,.06);
    }

    /* CTA with opulent gradient + ready state */
    .cta-wrap{display:flex;justify-content:center}
    .cta{
      display:inline-block;min-width:280px;padding:16px 24px;border-radius:16px;font-weight:900;border:0;cursor:pointer;font-size:1.06rem;
      color:var(--cta-ink);
      background:linear-gradient(100deg, var(--accent) 0%, var(--accent-2) 45%, var(--accent-3) 100%);
      background-size:200% 100%; box-shadow:var(--cta-shadow);
      transition:transform .08s ease, filter .15s ease, background-position .9s ease, opacity .2s ease;
      opacity:.55; /* not ready */
    }
    .cta.ready{ opacity:1 }
    .cta:hover{filter:brightness(.98); background-position:100% 0}
    .cta:active{transform:translateY(1px)}

    footer{max-width:980px;margin:0 auto;padding:18px 16px;color:var(--muted);text-align:center;font-size:.9rem}

    /* Accessibility focus */
    :focus{outline:2px solid rgba(183,139,250,.45);outline-offset:3px}
    .visually-hidden{position:absolute!important;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}

    /* ===== Floating Theme Toggle (top-left) ===== */
    .theme-fab{
      position:fixed; left:12px; top:12px; z-index:1000;
      display:flex; gap:6px; padding:6px 8px;
      background:var(--card-bg); border:1px solid var(--line); border-radius:12px;
      backdrop-filter:blur(8px);
      box-shadow:0 10px 20px rgba(0,0,0,.18), inset 0 1px 0 rgba(255,255,255,.06);
    }
    .theme-fab button{
      appearance:none; border:1px solid var(--line); border-radius:10px; padding:6px 10px;
      background:var(--control-bg); color:var(--ink); cursor:pointer;
      font-size:.85rem; font-weight:700;
    }
    .theme-fab button.active{
      background:linear-gradient(90deg, var(--accent), var(--accent-2));
      color:#fff; border-color:transparent;
    }

    /* ===== Animated Score Ring (premium) ===== */
    .gauge{
      --size: 200px;
      --val: 0deg; /* set via JS: score * 3.6deg */
      --fill: var(--accent);
      margin: 4px auto 10px; position:relative; width:var(--size); height:var(--size);
      filter: drop-shadow(0 12px 28px rgba(0,0,0,.24));
    }
    .gauge .ring{
      position:absolute; inset:0; border-radius:50%;
      background:
        conic-gradient(from -90deg, var(--fill) var(--val), var(--ring-track) 0);
      -webkit-mask: radial-gradient(circle calc(50% - var(--ring-gap)), transparent 98%, black 99%);
              mask: radial-gradient(circle calc(50% - var(--ring-gap)), transparent 98%, black 99%);
      transition: background .8s cubic-bezier(.22,1,.36,1);
    }
    .gauge .center{
      position:absolute; inset:var(--ring-gap); border-radius:50%;
      background:var(--card-bg);
      border:1px solid var(--line);
      display:grid; place-items:center; text-align:center;
      backdrop-filter:blur(var(--card-blur));
      box-shadow:inset 0 1px 0 rgba(255,255,255,.08);
    }
    .gauge .score-big{font-size:2.1rem; font-weight:900; letter-spacing:.4px}
    .gauge .tier{margin-top:4px; font-weight:800; letter-spacing:.3px; color:var(--ink-soft)}
    .gauge .note{margin-top:6px; font-size:.85rem; color:var(--muted)}

    /* Motion reduce */
    @media (prefers-reduced-motion: reduce){
      .sparkle{animation:none}
      .gauge .ring{transition:none}
      .cta{transition:none}
    }
  </style>
</head>
<body data-theme="dark">
  <div class="grain" aria-hidden="true"></div>
  <div class="sparkle" aria-hidden="true"></div>

  <!-- Floating theme toggle -->
  <div class="theme-fab" role="tablist" aria-label="Background theme">
    <button id="themeDark" class="active" role="tab" aria-selected="true">Black</button>
    <button id="themeLight" role="tab" aria-selected="false">White</button>
  </div>

  <header>
    <div class="brand">
      <div class="crest" aria-hidden="true"></div>
      <div>
        <h1>Lovefinder â€” Elite</h1>
        <p>Invitation-only compatibility engine for discerning matches.</p>
      </div>
    </div>
  </header>

  <main>
    <!-- YOUR PROFILE -->
    <section class="card" aria-labelledby="you-title">
      <h2 id="you-title" class="section-title">Your Profile</h2>
      <div class="grid two">
        <div>
          <label for="gender">Gender</label>
          <select id="gender">
            <option value="">-- Select --</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other/Unspecified</option>
          </select>
        </div>
        <div>
          <label for="age">Age</label>
          <input id="age" type="number" min="18" max="100" placeholder="e.g. 35" inputmode="numeric">
        </div>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div>
          <label for="background">Background</label>
          <select id="background">
            <option value="">-- Select --</option>
            <option>Upper</option>
            <option>Middle</option>
            <option>Lower</option>
          </select>
        </div>
      </div>
    </section>

    <!-- YOUR CLASSES -->
    <section class="card num-card" aria-labelledby="you-classes-title">
      <h2 id="you-classes-title" class="section-title">Your Classes (1â€“10)</h2>
      <div class="legend">Tap to set levels.</div>
      <div class="grid two">
        <div>
          <label>Appearance</label>
          <div id="pick-appearance" class="num-grid" data-for="appearance"></div>
          <select id="appearance" class="visually-hidden"></select>
        </div>
        <div>
          <label>Status</label>
          <div id="pick-status" class="num-grid" data-for="status"></div>
          <select id="status" class="visually-hidden"></select>
        </div>
        <div>
          <label>Confidence</label>
          <div id="pick-confidence" class="num-grid" data-for="confidence"></div>
          <select id="confidence" class="visually-hidden"></select>
        </div>
        <div>
          <label>Empathy</label>
          <div id="pick-empathy" class="num-grid" data-for="empathy"></div>
          <select id="empathy" class="visually-hidden"></select>
        </div>
      </div>
    </section>

    <!-- PARTNER PROFILE -->
    <section class="card" aria-labelledby="partner-title">
      <h2 id="partner-title" class="section-title">Desired Partner</h2>
      <div class="grid two">
        <div>
          <label for="pGender">Gender</label>
          <select id="pGender">
            <option value="">-- Select --</option>
            <option>Male</option>
            <option>Female</option>
            <option>Other/Unspecified</option>
          </select>
        </div>
        <div>
          <label for="pAge">Age</label>
          <input id="pAge" type="number" min="18" max="100" placeholder="e.g. 28" inputmode="numeric">
        </div>
      </div>
      <div class="grid two" style="margin-top:10px">
        <div>
          <label for="pBackground">Background</label>
          <select id="pBackground">
            <option value="">-- Select --</option>
            <option>Upper</option>
            <option>Middle</option>
            <option>Lower</option>
          </select>
        </div>
      </div>
    </section>

    <!-- PARTNER CLASSES -->
    <section class="card num-card" aria-labelledby="p-classes-title">
      <h2 id="p-classes-title" class="section-title">Partner Classes (1â€“10)</h2>
      <div class="legend">Tap to set desired levels.</div>
      <div class="grid two">
        <div>
          <label>Appearance</label>
          <div id="pick-pAppearance" class="num-grid" data-for="pAppearance"></div>
          <select id="pAppearance" class="visually-hidden"></select>
        </div>
        <div>
          <label>Status</label>
          <div id="pick-pStatus" class="num-grid" data-for="pStatus"></div>
          <select id="pStatus" class="visually-hidden"></select>
        </div>
        <div>
          <label>Confidence</label>
          <div id="pick-pConfidence" class="num-grid" data-for="pConfidence"></div>
          <select id="pConfidence" class="visually-hidden"></select>
        </div>
        <div>
          <label>Empathy</label>
          <div id="pick-pEmpathy" class="num-grid" data-for="pEmpathy"></div>
          <select id="pEmpathy" class="visually-hidden"></select>
        </div>
      </div>
    </section>

    <!-- ACTIONS -->
    <section class="card" aria-label="Actions">
      <div class="cta-wrap">
        <button id="calcBtn" class="cta" aria-label="Calculate">Calculate</button>
      </div>
      <div class="small" style="text-align:center;margin-top:8px">Button brightens when all required choices are set.</div>
    </section>

    <!-- RESULTS -->
    <section id="result" class="card" hidden>
      <h2 class="section-title">Result</h2>

      <!-- Premium score ring -->
      <div class="gauge" id="gauge">
        <div class="ring"></div>
        <div class="center">
          <div class="score-big" id="gScore">0</div>
          <div class="tier" id="gTier">â€”</div>
          <div class="note" id="gNote">Compatibility Index</div>
        </div>
      </div>

      <div style="text-align:center;margin-top:6px">
        <span id="youMeta" class="pill"></span>
        <span id="pMeta" class="pill"></span>
      </div>

      <hr>
      <div id="matchLevel" class="score" style="text-align:center"></div>
      <div class="small" id="labelText" style="margin-top:4px;text-align:center"></div>
      <hr>
      <div id="humanCopy" class="blurb"></div>
      <div id="humanCopy2" class="blurb" style="margin-top:8px"></div>
      <hr>
      <div id="adviceWrap" class="blurb"></div>
    </section>
  </main>

  <footer>
    v3.2 â€” Elite visuals: jeweled gradients, glass cards, animated score ring, couture micro-interactions.
  </footer>

  <script>
  // --------- helpers ----------
  const $ = (id)=>document.getElementById(id);
  const val=(id)=>{const el=$(id);return el?String(el.value||"").trim():"";};
  const clamp=(n,a,b)=>Math.min(b,Math.max(a,n));
  function num(id,min=1,max=10){const s=val(id);const x=parseInt(s,10);if(isNaN(x))return 0;return Math.max(min,Math.min(max,x));}

  // Fill 1..10 into hidden selects
  function fill10(id){
    const el=$(id);
    el.innerHTML = '<option value="">--</option>' + Array.from({length:10},(_,i)=>`<option>${i+1}</option>`).join('');
  }
  ["appearance","status","confidence","empathy","pAppearance","pStatus","pConfidence","pEmpathy"].forEach(fill10);

  // Build number pickers
  function buildPicker(containerId){
    const c=$(containerId);
    const selectId=c.getAttribute("data-for");
    c.innerHTML = Array.from({length:10},(_,i)=>`<button type="button" data-val="${i+1}">${i+1}</button>`).join('');
    c.addEventListener("click",(e)=>{
      const b=e.target.closest("button"); if(!b) return;
      const v=b.getAttribute("data-val");
      c.querySelectorAll("button").forEach(x=>x.classList.toggle("active", x===b));
      $(selectId).value = v;
      updateReady();
    });
  }
  ["pick-appearance","pick-status","pick-confidence","pick-empathy",
   "pick-pAppearance","pick-pStatus","pick-pConfidence","pick-pEmpathy"].forEach(buildPicker);

  // --------- THEME TOGGLE ----------
  const themeDarkBtn = $("themeDark");
  const themeLightBtn= $("themeLight");
  function setTheme(mode){
    const m = (mode==="light") ? "light" : "dark";
    document.documentElement.setAttribute("data-theme", m);
    themeDarkBtn.classList.toggle("active", m==="dark");
    themeLightBtn.classList.toggle("active", m==="light");
    themeDarkBtn.setAttribute("aria-selected", m==="dark");
    themeLightBtn.setAttribute("aria-selected", m==="light");
    try{ localStorage.setItem("lovefinder-theme", m); }catch(_){}
  }
  themeDarkBtn.onclick = ()=>setTheme("dark");
  themeLightBtn.onclick= ()=>setTheme("light");
  setTheme((()=>{ try{ return localStorage.getItem("lovefinder-theme")||"dark"; }catch(_){ return "dark"; } })());

  // --------- MODEL (Love only) ----------
  const WEIGHTS = {
    "Female": { appearance:0.23, status:0.38, empathy:0.12, confidence:0.27 },
    "Male":   { appearance:0.46, status:0.12, empathy:0.22, confidence:0.20 },
    "Other/Unspecified": { appearance:0.30, status:0.25, empathy:0.25, confidence:0.20 }
  };

  function baseAgeCurve(age){
    const midLift = (age>=30 && age<=45) ? 1.05 : 1.0;
    const seniorFall = age>55 ? Math.max(0.75, 1 - (age-55)*0.01) : 1.0;
    return midLift*seniorFall;
  }

  function traitUtility(person, weights){
    const s=(k)=>clamp(person.traits[k],1,10);
    const raw = weights.appearance*s("appearance")
              + weights.status*s("status")
              + weights.empathy*s("empathy")
              + weights.confidence*s("confidence");
    return raw/10;
  }

  function directionalGapMultiplier(evaluatorGender, evalAge, targetAge, targetUtility10){
    const gap = targetAge - evalAge;
    const opener = targetUtility10 >= 9 ? 0.5 : (targetUtility10>=8.5 ? 0.65 : 1.0);
    const abs = Math.abs(gap);
    let mult = 1.0;
    if(evaluatorGender==="Female"){
      if(gap>0){ if(abs<=4) mult=1.08; else if(abs<=12) mult=1.0; else mult=1.0-Math.min(0.35,(abs-12)*0.03); }
      else if(gap<0){ if(abs<=2) mult=0.98; else if(abs<=8) mult=0.9; else mult=1.0-Math.min(0.45,(abs-8)*0.04); }
    } else if(evaluatorGender==="Male"){
      if(gap<0){ if(abs<=8) mult=1.06; else if(abs<=12) mult=1.0; else mult=1.0-Math.min(0.30,(abs-12)*0.025); }
      else if(gap>0){ if(abs<=6) mult=0.98; else if(abs<=12) mult=0.92; else mult=1.0-Math.min(0.40,(abs-12)*0.03); }
    } else {
      if(abs<=12) mult=1.0; else mult=1.0 - Math.min(0.35,(abs-12)*0.025);
    }
    return 1.0 - (1.0 - mult)*opener;
  }

  function sideFit(evaluator, target){
    const w = WEIGHTS[evaluator.gender] || WEIGHTS["Other/Unspecified"];
    const utility = traitUtility(target, w);
    const ageBase = baseAgeCurve(target.age);
    const dir = directionalGapMultiplier(evaluator.gender, evaluator.age, target.age, utility*10);
    return { fit: Math.max(0, Math.min(1, utility*ageBase*dir)), utility, ageBase, dir, weights:w };
  }

  function mutualMatch(a,b){
    const left = sideFit(a,b);
    const right= sideFit(b,a);
    const score = Math.round(Math.sqrt(left.fit*right.fit)*100);
    return { score, left, right };
  }

  function labelBand(score){
    if(score>=70) return {band:"Likely", cls:"match-likely"};
    if(score>=60) return {band:"Match", cls:"match-match"};
    if(score>=45) return {band:"Challenging", cls:"match-chal"};
    return {band:"Unrealistic", cls:"match-unre"};
  }

  function contextModifier(you, partner){
    let mod=0;
    const yb=(you.background||"").toLowerCase(), pb=(partner.background||"").toLowerCase();
    if(yb && pb){
      if(yb===pb){ mod -= (yb==="upper"?2: yb==="middle"?1:0); }
      else { if((yb==="upper"&&pb==="lower")||(yb==="lower"&&pb==="upper")) mod+=2; else mod+=1; }
    }
    const gap=Math.abs(you.age-partner.age);
    if(gap>=20) mod+=6; else if(gap>=15) mod+=3; else if(gap>=10) mod+=1;
    return mod;
  }
  function applyContext(score, you, partner){
    const mod = contextModifier(you, partner);
    const damp = Math.max(0.6, 1 - mod*0.02);
    return Math.round(score*damp);
  }

  // LUDACRIS (Love)
  const LUDACRIS = { gapUnder25:30, teenVsOlder:40, extreme70v25:true, delta:12, deltaAge:15 };
  function isLudacris(you, partner){
    const gap = Math.abs(you.age - partner.age);
    const targetUnder25 = partner.age < 25;
    const targetTeen = partner.age <= 19;
    const seeker70plus = you.age >= 70;
    const wantTotal = (partner.traits.appearance + partner.traits.status + partner.traits.empathy + partner.traits.confidence);
    const haveTotal = (you.traits.appearance + you.traits.status + you.traits.empathy + you.traits.confidence);
    const demandDelta = wantTotal - haveTotal;

    if (targetUnder25 && gap >= LUDACRIS.gapUnder25) return true;
    if (targetTeen && you.age >= LUDACRIS.teenVsOlder) return true;
    if (seeker70plus && partner.age <= 25 && LUDACRIS.extreme70v25) return true;
    if (demandDelta >= LUDACRIS.delta && (you.age - partner.age) >= LUDACRIS.deltaAge) return true;
    return false;
  }

  // --------- IO ----------
  function readPerson(prefix){
    if(prefix==="p"){
      return {
        gender: val("pGender") || "Other/Unspecified",
        age: parseInt(val("pAge"),10) || 0,
        traits: {
          appearance: num("pAppearance")||0,
          status:     num("pStatus")||0,
          empathy:    num("pEmpathy")||0,
          confidence: num("pConfidence")||0,
        },
        background: val("pBackground") || ""
      };
    }
    return {
      gender: val("gender") || "Other/Unspecified",
      age: parseInt(val("age"),10) || 0,
      traits: {
        appearance: num("appearance")||0,
        status:     num("status")||0,
        empathy:    num("empathy")||0,
        confidence: num("confidence")||0,
      },
      background: val("background") || ""
    };
  }

  // --------- Human copy (Love) ----------
  const WORDS_LOVE = {
    Likely:      ["spark","flow","green light","synergy","aligned","smooth","locked-in","momentum","chemistry","strong fit","solid base","clicking"],
    Match:       ["promising","workable","steady","balanced","real shot","doable","potential","growing","explore","on track","worth it","solid chance"],
    Challenging: ["hurdles","friction","effort","rough edges","obstacles","heavy lift","uphill","bumpy","shaky","tension","patchy","mixed signals"],
    Unrealistic: ["off-track","mismatch","clash","low vibe","unlikely","disconnect","far apart","gap","no flow","hard to click","out of sync","different lanes"]
  };
  const TPL_LOVE = {
    Likely: [
      "The {w1} is obvious and things feel {w2}.",
      "This looks like a {w1}â€”real {w2} and easy momentum.",
      "Youâ€™re {w1} and the vibe is {w2}.",
      "Strong {w1}; connection feels {w2} from the start.",
      "{w1} energy with a {w2} path forward."
    ],
    Match: [
      "Feels {w1}â€”a {w2} path if you nurture it.",
      "A {w1} setup with {w2} potential.",
      "This is {w1}; give it time and {w2}.",
      "{w1} overall, with a {w2} chance to grow.",
      "A {w1} match thatâ€™s {w2} to build on."
    ],
    Challenging: [
      "There are {w1}; expect a {w2} road.",
      "Attraction is there, but {w1} make it {w2}.",
      "Some {w1} aheadâ€”could be {w2} without alignment.",
      "Itâ€™s {w1} right now; progress may feel {w2}.",
      "Youâ€™ll meet {w1}; keep expectations {w2}."
    ],
    Unrealistic: [
      "The vibe feels {w1}â€”chemistry is {w2}.",
      "This reads {w1}, with {w2} energy.",
      "Youâ€™re {w1}; connection will be {w2}.",
      "{w1} signals hereâ€”things may stay {w2}.",
      "Overall {w1}; likely {w2} for now."
    ]
  };
  function pick(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
  function humanize(band){
    const words = WORDS_LOVE[band]; const tpl = pick(TPL_LOVE[band]);
    let w1 = pick(words), w2 = pick(words); for(let i=0;i<4 && w2===w1;i++) w2 = pick(words);
    const s = tpl.replace("{w1}", w1).replace("{w2}", w2);
    return s.charAt(0).toUpperCase() + s.slice(1);
  }
  const WHY_LOVE = {
    Likely:      ["You notice the good stuff fastâ€”keep the pace natural.","Lean into shared energy and simple wins.","Let it breathe; the chemistry is already doing the work."],
    Match:       ["Thereâ€™s enough here to exploreâ€”small dates, real talk.","Focus on easy overlap; donâ€™t over-engineer it.","Keep it steady; curiosity beats intensity."],
    Challenging: ["Name the friction early and keep plans lightweight.","Short, low-stakes hangs help you read it clearly.","If it drains you, step back and reset the tempo."],
    Unrealistic: ["Itâ€™s okay to passâ€”save energy for better fits.","Wish them well and keep your bar where it belongs.","No need to force a vibe that isnâ€™t there."]
  };
  function whyLine(band){ return pick(WHY_LOVE[band]); }
  function renderAdvice(band){
    const a = humanize(band), b = whyLine(band);
    $("adviceWrap").innerHTML = `<p style="margin:0">${a}</p><p style="margin:8px 0 0 0">${b}</p>`;
  }

  // --------- READY STATE ----------
  const requiredIds = ["gender","age","background","pGender","pAge","pBackground",
    "appearance","status","confidence","empathy","pAppearance","pStatus","pConfidence","pEmpathy"];
  function isReady(){
    if(!(parseInt(val("age"),10)>=18 && parseInt(val("age"),10)<=100)) return false;
    if(!(parseInt(val("pAge"),10)>=18 && parseInt(val("pAge"),10)<=100)) return false;
    const needNonEmpty = ["gender","background","pGender","pBackground"];
    for(const id of needNonEmpty){ if(!val(id)) return false; }
    const need01 = ["appearance","status","confidence","empathy","pAppearance","pStatus","pConfidence","pEmpathy"];
    for(const id of need01){ if(num(id)===0) return false; }
    return true;
  }
  function updateReady(){
    $("calcBtn").classList.toggle("ready", isReady());
  }
  document.addEventListener("input", (e)=>{
    if(e.target.matches("select,input[type=number]")) updateReady();
  });

  // --------- GAUGE HELPERS ----------
  function setGauge(score, tier){
    const g = $("gauge");
    const ring = g.querySelector(".ring");
    const deg = Math.round(score * 3.6);
    // choose fill palette by tier
    let fill;
    if (tier==="Likely" || tier==="Match") fill = `conic-gradient(from -90deg, ${getComputedStyle(document.documentElement).getPropertyValue('--accent')} 0deg, var(--accent-2) ${deg/2}deg, var(--accent-3) var(--val), var(--ring-track) 0)`;
    else if (tier==="Challenging") fill = `conic-gradient(from -90deg, var(--warn) var(--val), var(--ring-track) 0)`;
    else fill = `conic-gradient(from -90deg, var(--low) var(--val), var(--ring-track) 0)`;

    ring.style.setProperty('--val', deg+'deg');
    // Smooth transition via background property
    ring.style.background = fill;

    $("gScore").textContent = score;
    $("gTier").textContent = tier;
  }

  // --------- CALCULATE ----------
  const calcBtn = $("calcBtn");
  calcBtn.onclick = async function handleCalculate(e){
    const btn = e.currentTarget;
    if (btn.dataset.busy === "1") return;
    btn.dataset.busy = "1"; btn.disabled = true;

    const resEl = $("result");
    const youMeta = $("youMeta"), pMeta=$("pMeta"), matchEl=$("matchLevel"), labelEl=$("labelText");
    const copy1=$("humanCopy"), copy2=$("humanCopy2"), advice=$("adviceWrap");
    youMeta.textContent=""; pMeta.textContent=""; matchEl.textContent=""; labelEl.textContent="";
    copy1.textContent=""; copy2.textContent=""; advice.innerHTML="";

    try{
      if(!isReady()){
        alert("Please set: gender, age, background, and all class levels (1â€“10) for both profiles.");
        document.body.classList.remove("celebrate");
        return;
      }

      const me   = readPerson("");
      const them = readPerson("p");

      if (isLudacris(me, them) || isLudacris(them, me)) {
        resEl.hidden = false;
        youMeta.textContent = `${me.gender}, ${me.age} â€¢ A${me.traits.appearance}/S${me.traits.status}/E${me.traits.empathy}/C${me.traits.confidence}`;
        pMeta.textContent   = `${them.gender}, ${them.age} â€¢ A${them.traits.appearance}/S${them.traits.status}/E${them.traits.empathy}/C${them.traits.confidence}`;
        matchEl.className = "score match-unre";
        matchEl.textContent = "LUDACRIS";
        labelEl.textContent = "Result withheld. No comments.";
        copy1.textContent = "Inputs triggered the hard gate (extreme age gap or outsized demands).";
        copy2.textContent = "Adjust ages or expectations and try again.";
        setGauge(0, "Unrealistic");
        document.body.classList.remove("celebrate");
        return;
      }

      const res = mutualMatch(me, them);
      let finalScore = applyContext(res.score, me, them);
      finalScore = clamp(finalScore, 0, 100);
      const {band, cls} = labelBand(finalScore);

      youMeta.textContent = `${me.gender}, ${me.age} â€¢ A${me.traits.appearance}/S${me.traits.status}/E${me.traits.empathy}/C${me.traits.confidence}`;
      pMeta.textContent   = `${them.gender}, ${them.age} â€¢ A${them.traits.appearance}/S${them.traits.status}/E${them.traits.empathy}/C${them.traits.confidence}`;

      matchEl.className = "score "+cls;
      matchEl.textContent = `${finalScore} / 100`;
      labelEl.textContent = band;

      copy1.textContent = humanize(band);
      copy2.textContent = whyLine(band);
      renderAdvice(band);

      resEl.hidden = false;

      setGauge(finalScore, band);
      if (band==="Likely" || band==="Match") document.body.classList.add("celebrate");
      else document.body.classList.remove("celebrate");

    } finally {
      btn.dataset.busy = "0";
      btn.disabled = false;
    }
  };

  // --------- INIT ---------
  updateReady();
  </script>
</body>
</html>
